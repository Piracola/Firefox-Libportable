# GitHub Actions 工作流：浏览器便携版打包
# 这个工作流支持 Zen 浏览器和 Firefox 浏览器的便携版构建
name: Firefox Portable Build

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '构建原因'
        required: false
        default: '手动触发构建'
        type: string
  push:
    branches:
      - main
      - master
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-firefox:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    steps:
    # 步骤 1: 检出代码仓库
    - name: Checkout repository
      uses: actions/checkout@v4

    # 步骤 2: 恢复版本缓存
    - name: Cache version info
      uses: actions/cache@v4
      with:
        path: firefox_last_version.txt
        key: firefox-version-${{ github.run_number }}
        restore-keys: |
          firefox-version-

    # 步骤 3: 检查 Firefox 浏览器版本更新
    - name: Check Firefox Browser version
      id: version-check
      run: |
        # 获取 Firefox 最新版本信息
        $latest_url = "https://product-details.mozilla.org/1.0/firefox_versions.json"
        $trigger_event = "${{ github.event_name }}"
        $version_file = "firefox_last_version.txt"
        
        try {
          $response = Invoke-RestMethod -Uri $latest_url
          $latest_version = $response.LATEST_FIREFOX_VERSION
          echo "firefox_version=$latest_version" >> $env:GITHUB_OUTPUT
          
          # 设置默认构建原因
          $build_reason = ""
          $should_build = $false
          
          # 手动触发和代码提交触发总是执行构建
          if ($trigger_event -eq "workflow_dispatch") {
            $build_reason = "手动触发构建"
            $should_build = $true
          } elseif ($trigger_event -eq "push") {
            $build_reason = "代码提交触发"
            $should_build = $true
          } else {
            # 定时触发：检查版本更新
            if (Test-Path $version_file) {
              $last_version = Get-Content $version_file
              if ($last_version -eq $latest_version) {
                $build_reason = "无需更新"
                $should_build = $false
              } else {
                $build_reason = "自动更新构建"
                $should_build = $true
              }
            } else {
              $build_reason = "首次构建"
              $should_build = $true
            }
          }
          
          # 保存版本信息并输出构建结果
          if ($should_build) {
            $latest_version | Out-File -FilePath $version_file -Encoding UTF8
          }
          
          echo "should_build=$should_build" >> $env:GITHUB_OUTPUT
          echo "build_reason=$build_reason" >> $env:GITHUB_OUTPUT
          
        } catch {
          echo "should_build=true" >> $env:GITHUB_OUTPUT
          echo "build_reason=错误回退构建" >> $env:GITHUB_OUTPUT
        }

    # 步骤 4: 下载并解压 Firefox 浏览器
    - name: Download and Extract Firefox Browser
      run: |
        # 下载并解压 Firefox 浏览器
        $version = "${{ steps.version-check.outputs.firefox_version }}"
        $url = "https://download-installer.cdn.mozilla.net/pub/firefox/releases/$version/win64/en-US/Firefox%20Setup%20$version.exe"
        $installer = "$env:GITHUB_WORKSPACE\firefox-installer.exe"
        $extractDir = "D:\firefox"
        
        # 下载安装程序
        Invoke-WebRequest -Uri $url -OutFile $installer
        
        # 创建解压目录并解压
        New-Item -ItemType Directory -Force -Path $extractDir
        7z x "$installer" -o"$extractDir" -y
        
        # 重命名 core 文件夹为 Firefox 并删除 setup.exe
        if (Test-Path "$extractDir\core") {
          Rename-Item -Path "$extractDir\core" -NewName "Firefox" -Force
        }
        if (Test-Path "$extractDir\setup.exe") {
          Remove-Item -Path "$extractDir\setup.exe" -Force
        }

    # 步骤 5: 创建 Firefox 便携版
    - name: Create Firefox Portable Package
      run: |
        # 复制 libportable 工具并创建便携版
        $firefoxDir = "D:\firefox\Firefox"
        $libportableSource = "$env:GITHUB_WORKSPACE\libportable"
        
        # 复制所有 libportable 工具文件
        Copy-Item -Path "$libportableSource\*" -Destination $firefoxDir -Recurse -Force
        
        # 复制开始.bat到firefox目录
        Copy-Item -Path "$env:GITHUB_WORKSPACE\开始.bat" -Destination "D:\firefox" -Force

        # 运行便携版创建脚本
        Set-Location -Path $firefoxDir
        ./injectpe.bat
      continue-on-error: true

    # 步骤 6: 打包并发布便携版
    - name: Package and Release Portable Build
      id: package
      run: |
        # 打包便携版文件
        $sourceDir = "D:\*"
        $outputZip = "$env:GITHUB_WORKSPACE\Firefox.zip"
        7z a -tzip "$outputZip" "$sourceDir"
        
        # 设置发布信息
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        echo "firefox_version=${{ steps.version-check.outputs.firefox_version }}" >> $env:GITHUB_OUTPUT
        echo "build_reason=${{ steps.version-check.outputs.build_reason }}" >> $env:GITHUB_OUTPUT
        echo "formatted_build_time=$buildTime" >> $env:GITHUB_OUTPUT

    # 步骤 7: 创建 GitHub Release
    - name: Create Release and Upload Portable Package
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: firefox-${{ steps.package.outputs.firefox_version }}
        name: Firefox Portable ${{ steps.package.outputs.firefox_version }}
        body: |
          Firefox ${{ steps.package.outputs.firefox_version }} 便携版
          这是一个自动构建的 Firefox 浏览器便携版本，基于 libportable 项目。

          使用方法：
          1. 下载 [Firefox.zip](https://github.com/Piracola/Firefox-Libportable/releases/latest/download/firefox.zip) 文件
          2. 解压到任意目录
          3. 运行 开始.bat 即可创建快捷方式
        draft: false
        prerelease: false
        files: |
          ${{ github.workspace }}\Firefox.zip

  cleanup:
    if: always()
    needs: build-firefox
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 10